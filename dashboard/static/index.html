<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>AI-toolkit Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f59e0b'><path d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ─── Design tokens (normalized) ───────────────────────────────────────── */
    :root {
      /* Surfaces */
      --bg: #09090b;
      --bg-elevated: #0f0f12;
      --surface: #18181b;
      --surface-hover: #27272a;
      --card: #18181b;
      --border: #27272a;
      --border-subtle: #1f1f23;
      /* Text */
      --fg: #fafafa;
      --fg-muted: #a1a1aa;
      --muted: #71717a;
      /* Semantic */
      --accent: #f59e0b;
      --accent-soft: #fbbf24;
      --accent-dim: rgba(245,158,11,0.12);
      --accent-glow: rgba(245,158,11,0.25);
      --success: #22c55e;
      --success-dim: rgba(34,197,94,0.12);
      --warning: #eab308;
      --danger: #ef4444;
      --danger-dim: rgba(239,68,68,0.12);
      --info: #3b82f6;
      /* Radius */
      --radius: 14px;
      --radius-sm: 8px;
      --radius-md: 10px;
      --radius-lg: 20px;
      /* Shadow */
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.25);
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
      /* Spacing scale (4/8/12/16/24/32/48) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      /* Typography */
      --font-sans: 'Plus Jakarta Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 2rem;
      --leading-tight: 1.25;
      --leading-normal: 1.5;
      --leading-relaxed: 1.6;
    }
    html { scroll-behavior: smooth; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      line-height: var(--leading-relaxed);
      -webkit-font-smoothing: antialiased;
    }
    /* Focus visible for a11y */
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .skip-link {
      position: absolute;
      top: var(--space-2);
      left: var(--space-4);
      padding: var(--space-2) var(--space-3);
      background: var(--accent);
      color: #0a0a0a;
      font-weight: 600;
      font-size: var(--text-sm);
      border-radius: var(--radius-sm);
      text-decoration: none;
      z-index: 1001;
      transform: translateY(-120%);
      transition: transform 0.2s;
    }
    .skip-link:focus { transform: translateY(0); outline: 2px solid var(--fg); outline-offset: 2px; }
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
      z-index: 9999; padding: var(--space-4);
    }
    .modal-overlay .modal-content {
      background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius);
      padding: var(--space-6); box-shadow: var(--shadow-lg);
    }
    .modal-overlay .modal-content h2 { margin: 0 0 var(--space-3); font-size: var(--text-xl); }
    .modal-overlay .modal-content p { margin: 0 0 var(--space-4); color: var(--fg-muted); font-size: var(--text-sm); }
    .modal-overlay .modal-content input {
      width: 100%; padding: var(--space-3); margin-bottom: var(--space-4);
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--fg); font-size: var(--text-base);
    }
    .modal-overlay .modal-content button {
      width: 100%; padding: var(--space-3); background: var(--accent); color: #0a0a0a;
      border: none; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245,158,11,0.08) 0%, transparent 50%),
                  radial-gradient(ellipse 60% 40% at 100% 100%, rgba(34,197,94,0.04) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: var(--space-8) var(--space-6); position: relative; z-index: 1; }
    /* ─── Header + nav ─────────────────────────────────────────────────────── */
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: var(--space-6);
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 1px solid var(--border-subtle);
    }
    .header-brand { flex: 1; min-width: 0; }
    h1 {
      font-size: var(--text-3xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: var(--leading-tight);
      background: linear-gradient(135deg, #fff 0%, var(--fg-muted) 50%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { color: var(--muted); font-size: var(--text-base); margin-top: var(--space-1); font-weight: 500; }
    .nav-anchors {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }
    .nav-anchors a {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--fg-muted);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: color 0.2s, background 0.2s;
    }
    .nav-anchors a:hover { color: var(--accent); background: var(--accent-dim); }
    .nav-anchors a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .header-actions { display: flex; gap: var(--space-2); align-items: center; flex-shrink: 0; }
    .btn-icon {
      width: 40px; height: 40px;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--muted);
      cursor: pointer; transition: all 0.2s ease;
      font-size: var(--text-sm);
    }
    .btn-icon:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-dim); }
    .btn-icon.btn-text { width: auto; padding: 0 var(--space-4); font-size: var(--text-sm); }
    .btn-icon.loading { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ─── Badge / status chip ───────────────────────────────────────────────── */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      font-weight: 500;
      border-radius: 999px;
      line-height: 1;
    }
    .badge-success { background: var(--success-dim); color: var(--success); }
    .badge-warn { background: rgba(234,179,8,0.15); color: var(--warning); }
    .badge-error { background: var(--danger-dim); color: var(--danger); }
    .badge-muted { background: var(--surface-hover); color: var(--muted); }
    section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow);
      scroll-margin-top: var(--space-4);
    }
    section h2 {
      font-size: var(--text-sm);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .section-desc {
      font-size: var(--text-sm);
      color: var(--muted);
      margin-bottom: var(--space-4);
      line-height: var(--leading-normal);
    }
    .mcp-howto {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
    }
    .mcp-howto summary {
      cursor: pointer;
      color: var(--accent);
      font-weight: 600;
      font-size: var(--text-base);
    }
    .mcp-howto-content {
      margin-top: var(--space-4);
      color: var(--fg-muted);
      line-height: var(--leading-relaxed);
    }
    .mcp-howto-content p { margin-bottom: var(--space-2); }
    .mcp-howto-content p:last-child { margin-bottom: 0; }
    .mcp-howto code { background: var(--bg); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: 0.85em; font-family: var(--font-mono); }
    .mcp-howto .btn-copy { margin-left: var(--space-1); padding: var(--space-1) var(--space-2); font-size: var(--text-xs); }
    .mcp-add-row { display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap; }
    .mcp-add-row select { padding: var(--space-2) var(--space-3); background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--fg); font-size: var(--text-sm); min-width: 180px; }
    .mcp-section { margin-bottom: var(--space-6); }
    .mcp-section:last-child { margin-bottom: 0; }
    .mcp-section-label { font-size: var(--text-xs); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: var(--space-2); }
    .mcp-enabled-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      min-height: 2.5rem;
      align-items: center;
    }
    .mcp-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-sm);
      font-family: var(--font-mono);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      max-width: 12rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mcp-chip .mcp-chip-remove {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      transition: color 0.2s, background 0.2s;
    }
    .mcp-chip .mcp-chip-remove:hover { color: var(--danger); background: var(--danger-dim); }
    .mcp-empty-hint { color: var(--muted); font-size: var(--text-sm); font-style: italic; }
    .services {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: var(--space-4);
    }
    @media (max-width: 768px) { .services { grid-template-columns: repeat(2, 1fr); gap: var(--space-3); } }
    @media (max-width: 600px) { .services { grid-template-columns: 1fr; } }
    .service {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--fg);
      transition: all 0.25s ease;
    }
    .service:hover {
      border-color: var(--accent);
      background: var(--accent-dim);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }
    .service .status {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
    }
    .service .status.ok {
      background: var(--success);
      box-shadow: 0 0 12px var(--success);
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .service .status.fail { background: var(--danger); }
    .service .label { flex: 1; font-size: 0.95rem; font-weight: 500; min-width: 0; }
    .service .external { opacity: 0.4; font-size: 0.75rem; flex-shrink: 0; }
    .service-card {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: var(--space-5) var(--space-6);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      transition: all 0.25s ease;
      min-height: 4.5rem;
    }
    .service-card:hover { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-dim); }
    .service-card.fail { border-color: var(--danger); background: var(--danger-dim); }
    .service-card .service-name {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--fg);
      margin-bottom: var(--space-2);
      letter-spacing: 0.01em;
    }
    .service-card .row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 0;
    }
    .service-card .row .service {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 0;
      overflow: hidden;
      flex: 1;
    }
    .service-card .row .service .label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--fg);
      min-width: 4rem;
    }
    .service-card .hint {
      font-size: var(--text-sm);
      line-height: var(--leading-normal);
      color: var(--fg-muted);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      padding-left: var(--space-6);
      border-top: 1px solid var(--border-subtle);
      word-wrap: break-word;
    }
    .service-card.fail .hint {
      color: var(--fg);
      border-top-color: rgba(239, 68, 68, 0.2);
    }
    .service-card .hint a { color: var(--accent); }
    .status-summary {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding: var(--space-3) var(--space-5);
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-weight: 500;
    }
    .status-summary.all-ok { border-left: 4px solid var(--success); }
    .status-summary.has-issues { border-left: 4px solid var(--warning); }
    .throughput-subsection {
      margin-bottom: var(--space-6);
    }
    .throughput-subsection h3 {
      font-size: var(--text-base);
      font-weight: 600;
      margin: 0 0 var(--space-1);
    }
    .subsection-desc {
      font-size: var(--text-sm);
      color: var(--muted);
      margin: 0 0 var(--space-3);
    }
    .throughput-panel {
      padding: var(--space-5);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
    }
    .throughput-controls {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: var(--space-5);
    }
    .throughput-controls select {
      padding: var(--space-2) var(--space-4);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      min-width: 200px;
    }
    .throughput-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--space-4);
    }
    .throughput-metric {
      padding: var(--space-3) var(--space-4);
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }
    .throughput-value {
      display: block;
      font-family: var(--font-mono);
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--accent);
    }
    .throughput-label {
      font-size: var(--text-xs);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--space-1);
    }
    .throughput-error {
      color: var(--danger);
      font-size: var(--text-sm);
      margin-top: var(--space-3);
    }
    .throughput-loading {
      color: var(--muted);
      font-size: var(--text-sm);
      margin-top: var(--space-3);
    }
    .throughput-stats {
      margin-top: var(--space-6);
      padding-top: var(--space-5);
      border-top: 1px solid var(--border-subtle);
    }
    .throughput-stats-title { display: none; }
    .throughput-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: var(--space-4);
    }
    .throughput-stat-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
    }
    .throughput-stat-card.loaded {
      border-left: 3px solid var(--accent);
    }
    .throughput-stat-model {
      font-weight: 600;
      font-size: var(--text-sm);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .throughput-stat-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      color: var(--bg);
      border-radius: var(--radius-sm);
      font-weight: 500;
    }
    .throughput-stat-row {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }
    .throughput-stat-row .label { color: var(--muted); }
    .throughput-stat-row .value { font-family: var(--font-mono); font-weight: 500; }
    .throughput-empty {
      color: var(--muted);
      font-size: var(--text-sm);
      grid-column: 1 / -1;
    }
    .throughput-service-usage {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: var(--space-4);
    }
    .throughput-service-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
    }
    .throughput-service-card h4 {
      font-size: var(--text-sm);
      font-weight: 600;
      margin: 0 0 var(--space-3);
    }
    .throughput-service-row {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }
    .throughput-service-row .label { color: var(--muted); }
    .throughput-service-row .value { font-family: var(--font-mono); font-weight: 500; }
    .models-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
    }
    @media (max-width: 900px) { .models-grid { grid-template-columns: 1fr; gap: var(--space-4); } }
    .model-panel {
      background: var(--bg-elevated);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      overflow: visible;
      transition: border-color 0.2s;
    }
    .model-panel:hover { border-color: var(--border); }
    .models-grid .model-panel:first-child { position: relative; z-index: 2; }
    .model-panel h3 {
      font-size: var(--text-sm);
      font-weight: 600;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--border-subtle);
      color: var(--fg-muted);
      letter-spacing: 0.02em;
    }
    .model-list {
      min-height: 120px;
      max-height: 260px;
      overflow-y: auto;
      font-family: var(--font-mono);
      font-size: var(--text-sm);
    }
    .model-list::-webkit-scrollbar { width: 6px; }
    .model-list::-webkit-scrollbar-track { background: transparent; }
    .model-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-5);
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.2s;
    }
    .model-item:last-child { border-bottom: none; }
    .model-item:hover { background: var(--surface-hover); }
    .model-item .name { color: var(--fg); }
    .model-item .meta { color: var(--muted); font-size: var(--text-xs); }
    .btn-model-delete {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      border-radius: var(--radius-sm);
    }
    .btn-model-delete:hover { color: var(--danger); background: var(--surface-hover); }
    .model-category { font-size: var(--text-xs); text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-top: var(--space-1); }
    .pull-area {
      padding: var(--space-4) var(--space-5);
      border-top: 1px solid var(--border-subtle);
    }
    .pull-row {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }
    .quick-pills {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      margin-bottom: var(--space-3);
    }
    .pill {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .pill:hover { border-color: var(--accent); color: var(--accent); }
    .mcp-remove-btn:hover { border-color: var(--danger); color: var(--danger); }
    .model-select-wrap {
      position: relative;
      flex: 1;
      min-width: 200px;
    }
    .model-select-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2) var(--space-4);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .model-select-trigger:hover, .model-select-trigger.open { border-color: var(--accent); background: var(--accent-dim); }
    .model-select-trigger .chevron { transition: transform 0.2s; opacity: 0.7; }
    .model-select-trigger.open .chevron { transform: rotate(180deg); }
    .model-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: var(--space-2);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      max-height: 320px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
    }
    .model-select-search {
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--border-subtle);
    }
    .model-select-search input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }
    .model-select-search input:focus { outline: none; border-color: var(--accent); }
    .model-select-dropdown .section-label {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      border-bottom: 1px solid var(--border-subtle);
    }
    .model-select-option {
      padding: var(--space-2) var(--space-4);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }
    .model-select-option:hover { background: var(--surface-hover); }
    .model-select-option.installed { color: var(--muted); cursor: default; }
    .model-select-option.installed:hover { background: transparent; }
    .model-select-option .badge { font-size: 0.7rem; color: var(--success); }
    .model-select-option .size { font-size: 0.8rem; color: var(--muted); }
    #ollama-select-options { overflow-y: auto; max-height: 220px; }
    .model-select-custom {
      padding: var(--space-3) var(--space-4);
      border-top: 1px solid var(--border-subtle);
    }
    .model-select-custom input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }
    .model-select-custom input:focus { outline: none; border-color: var(--accent); }
    .last-updated { font-size: var(--text-xs); color: var(--muted); margin-top: var(--space-2); }
    input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: var(--space-2) var(--space-4);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }
    input:focus { outline: none; border-color: var(--accent); }
    button {
      padding: var(--space-2) var(--space-5);
      background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%);
      border: none;
      border-radius: var(--radius-sm);
      color: #0a0a0a;
      font-weight: 600;
      font-family: inherit;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(245,158,11,0.3);
    }
    button:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    button.secondary {
      background: var(--surface);
      color: var(--fg);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .progress-area {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--bg);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }
    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: var(--space-3);
    }
    .progress-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-soft) 100%);
      border-radius: 999px;
      transition: width 0.3s ease;
    }
    .log {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      white-space: pre-wrap;
      max-height: 180px;
      overflow-y: auto;
      color: var(--fg-muted);
      background: var(--bg);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }
    .log::-webkit-scrollbar { width: 6px; }
    .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .empty {
      padding: var(--space-10) var(--space-5);
      text-align: center;
      color: var(--muted);
      font-size: var(--text-sm);
    }
    .empty .hint { margin-top: var(--space-2); font-size: var(--text-sm); opacity: 0.85; }
    .toast-container {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    .toast {
      padding: var(--space-4) var(--space-5);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .toast.success { border-color: var(--success); background: var(--success-dim); }
    .toast.error { border-color: var(--danger); background: var(--danger-dim); }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(12px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, var(--surface) 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: skeleton 1.5s ease-in-out infinite;
      border-radius: var(--radius-sm);
    }
    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-line { height: 1rem; margin-bottom: var(--space-2); }
    .skeleton-line.short { width: 60%; }

    /* Mobile-first responsive styles */
    @media (max-width: 768px) {
      body { overflow-x: hidden; }
      .container { padding: var(--space-4); }
      header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }
      h1 { font-size: var(--text-2xl); }
      .subtitle { font-size: var(--text-sm); }
      .header-actions {
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .btn-icon {
        min-width: 44px;
        min-height: 44px;
      }
      .btn-icon.btn-text { min-width: 44px; padding: 0 var(--space-4); }
      section {
        padding: var(--space-5) var(--space-4);
        margin-bottom: var(--space-5);
      }
      .section-desc { font-size: var(--text-sm); margin-bottom: var(--space-3); }
      .services { grid-template-columns: 1fr; gap: var(--space-3); }
      .service-card { padding: var(--space-4); }
      .service-card .hint {
        padding-left: 0;
        font-size: var(--text-sm);
        margin-top: var(--space-2);
        padding-top: var(--space-2);
      }
      .status-summary {
        font-size: var(--text-sm);
        padding: var(--space-3) var(--space-4);
        flex-wrap: wrap;
      }
      .models-grid { gap: var(--space-4); }
      .model-panel h3 { padding: var(--space-3) var(--space-4); font-size: var(--text-sm); }
      .model-list { max-height: 200px; font-size: var(--text-xs); }
      .model-item { padding: var(--space-2) var(--space-4); flex-wrap: wrap; gap: var(--space-1); }
      .model-item .name { word-break: break-word; }
      .pull-area { padding: var(--space-4); }
      .pull-row {
        flex-direction: row;
        flex-wrap: wrap;
        gap: var(--space-3);
      }
      .pull-row .model-select-wrap { flex: 1 1 100%; min-width: 0; }
      .pull-row button { flex: 1 1 120px; min-width: 0; }
      .model-select-wrap { min-width: 0; }
      .model-select-trigger { font-size: 0.85rem; }
      input[type="text"] { min-width: 0; }
      button {
        min-height: 44px;
        padding: 0.75rem 1.25rem;
      }
      .mcp-howto {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-sm);
      }
      .mcp-howto-content p { font-size: var(--text-sm); }
      .mcp-howto code {
        display: inline-block;
        max-width: 100%;
        overflow-wrap: break-word;
        word-break: break-word;
      }
      .mcp-add-row {
        flex-direction: column;
        align-items: stretch;
      }
      .mcp-add-row select { width: 100%; }
      .toast-container {
        left: var(--space-4);
        right: var(--space-4);
        bottom: var(--space-4);
      }
      .toast { padding: var(--space-3) var(--space-4); font-size: var(--text-sm); }
    }

    @media (max-width: 480px) {
      .container { padding: var(--space-3); }
      h1 { font-size: var(--text-xl); }
      section { padding: var(--space-4) var(--space-3); }
      .model-list { max-height: 160px; }
      .model-select-dropdown {
        max-height: 60vh;
        left: var(--space-2);
        right: var(--space-2);
        width: auto;
      }
      .quick-pills { gap: var(--space-1); }
      .pill { padding: var(--space-1) var(--space-3); font-size: var(--text-xs); }
    }

  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="container" id="main-content" role="main">
    <header>
      <div class="header-brand">
        <h1>AI-toolkit Dashboard</h1>
        <p class="subtitle">Unified model management — Ollama, ComfyUI, and services</p>
        <nav class="nav-anchors" aria-label="Page sections">
          <a href="#services-section">Services</a>
          <a href="#throughput-section">Token Throughput</a>
          <a href="#models-section">Model Library</a>
        </nav>
      </div>
      <div class="header-actions">
        <button class="btn-icon btn-text" id="rebuild-hint" title="Copy rebuild command" aria-label="Copy rebuild command">↻ Rebuild</button>
        <button class="btn-icon" id="refresh-btn" title="Refresh status" aria-label="Refresh status">↻</button>
      </div>
    </header>

    <section id="services-section">
      <h2>Services</h2>
      <p class="section-desc">Click a service to open it. MCP Gateway provides shared tools for Open WebUI, N8N, Cursor, and OpenClaw.</p>
      <div class="status-summary" id="status-summary" style="display:none;" role="status" aria-live="polite"></div>
      <div class="services" id="services">
        <div class="skeleton skeleton-line" style="height:52px;width:100%;"></div>
        <div class="skeleton skeleton-line" style="height:52px;width:100%;"></div>
        <div class="skeleton skeleton-line" style="height:52px;width:100%;"></div>
      </div>
      <details class="mcp-howto" open>
        <summary>MCP Gateway — Deploy tools</summary>
        <div class="mcp-howto-content">
          <div class="mcp-section">
            <div class="mcp-section-label">Enabled tools <span id="mcp-gateway-status" class="badge badge-muted" title="Gateway status">—</span></div>
            <div class="mcp-enabled-chips" id="mcp-enabled-chips">
              <span class="mcp-empty-hint" id="mcp-empty-hint">None — add from catalog or paste a URL below</span>
            </div>
          </div>
          <div id="mcp-dynamic-row" class="mcp-section" style="display:none;">
            <div class="mcp-section-label">Add from catalog</div>
            <div class="mcp-add-row">
              <select id="mcp-add-select">
                <option value="">Choose a tool...</option>
              </select>
              <button type="button" id="mcp-add-btn">Add</button>
            </div>
            <div class="mcp-section-label" style="margin-top:var(--space-4);">Or add by URL or name</div>
            <div class="mcp-add-row">
              <input type="text" id="mcp-custom-input" placeholder="Paste Docker Hub URL or server name (e.g. hugging-face)" aria-label="Custom MCP server name or Docker Hub URL" style="flex:1;min-width:200px;">
              <button type="button" id="mcp-add-custom-btn" class="secondary">Add</button>
            </div>
          </div>
          <div id="mcp-static-row" class="mcp-section" style="display:none;">
            <p><strong>Add tool:</strong> Run from repo root — <code id="mcp-add-cmd">./scripts/mcp_add.sh fetch</code> <button type="button" class="btn-copy" id="mcp-add-copy" title="Copy add command" aria-label="Copy add command">Copy</button></p>
            <p><strong>Remove:</strong> <code id="mcp-remove-cmd">./scripts/mcp_remove.sh fetch</code> <button type="button" class="btn-copy" id="mcp-remove-copy" title="Copy remove command" aria-label="Copy remove command">Copy</button></p>
            <div class="mcp-add-row">
              <select id="mcp-add-select-static">
                <option value="">Choose a tool...</option>
              </select>
              <button type="button" id="mcp-add-btn-static" class="secondary">Copy add command</button>
            </div>
            <p style="margin-top:var(--space-2);font-size:var(--text-sm);color:var(--fg-muted);">Or run from repo root: <code>./scripts/mcp_add.sh &lt;server-name&gt;</code> — use any name from <a href="https://hub.docker.com/mcp" target="_blank" rel="noopener">Docker MCP Catalog</a></p>
          </div>
          <div class="mcp-section" style="margin-top:var(--space-6);padding-top:var(--space-4);border-top:1px solid var(--border-subtle);">
            <div class="mcp-section-label">Connect</div>
            <p>Open WebUI → Admin Settings → External Tools → MCP (Streamable HTTP) → <code>http://localhost:8811/mcp</code>. N8N: MCP Client Tool node → <code>http://mcp-gateway:8811/mcp</code>. Cursor/Claude: <code>http://localhost:8811/mcp</code>.</p>
            <p><a href="https://hub.docker.com/mcp" target="_blank" rel="noopener">Browse 200+ tools in Docker MCP Catalog ↗</a></p>
          </div>
        </div>
      </details>
    </section>

    <section id="throughput-section">
      <h2>Token Throughput</h2>
      <p class="section-desc">Benchmark models, monitor performance, and see which services are using them.</p>

      <div class="throughput-subsection">
        <h3>1. Benchmark</h3>
        <p class="subsection-desc">Run a quick test to measure inference speed.</p>
        <div class="throughput-panel">
          <div class="throughput-controls">
            <div class="model-select-wrap" style="max-width:280px;">
              <select id="throughput-model-select" aria-label="Model for benchmark">
                <option value="">Loading models...</option>
              </select>
            </div>
            <button type="button" id="throughput-run-btn">Run benchmark</button>
          </div>
          <div id="throughput-results" class="throughput-results" style="display:none;">
            <div class="throughput-metric">
              <span class="throughput-value" id="throughput-tps">—</span>
              <span class="throughput-label">Output tokens/sec</span>
            </div>
            <div class="throughput-metric">
              <span class="throughput-value" id="throughput-output-tokens">—</span>
              <span class="throughput-label">Output tokens</span>
            </div>
            <div class="throughput-metric">
              <span class="throughput-value" id="throughput-eval-ms">—</span>
              <span class="throughput-label">Eval time (ms)</span>
            </div>
            <div class="throughput-metric">
              <span class="throughput-value" id="throughput-load-ms">—</span>
              <span class="throughput-label">Load time (ms)</span>
            </div>
          </div>
          <div id="throughput-error" class="throughput-error" style="display:none;"></div>
          <div id="throughput-loading" class="throughput-loading" style="display:none;">Running benchmark...</div>
        </div>
      </div>

      <div class="throughput-subsection">
        <h3>2. Model status & performance</h3>
        <p class="subsection-desc">Current loaded models and historical throughput (peak, percentiles). Data from benchmarks and real usage via Model Gateway.</p>
        <div class="throughput-panel">
          <div id="throughput-stats" class="throughput-stats">
            <div id="throughput-stats-grid" class="throughput-stats-grid">
              <div class="throughput-empty" id="throughput-stats-empty">No data yet. Run a benchmark or use models via the Model Gateway.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="throughput-subsection">
        <h3>3. Service usage</h3>
        <p class="subsection-desc">Which services are taxing which models. Tracked for requests through the Model Gateway (Open WebUI, N8N, etc.).</p>
        <div class="throughput-panel">
          <div id="throughput-service-usage" class="throughput-service-usage">
            <div class="throughput-empty" id="throughput-service-usage-empty">No service usage yet. Use models via the Model Gateway (e.g. Open WebUI with OPENAI_API_BASE).</div>
          </div>
        </div>
      </div>
    </section>

    <section id="models-section">
      <h2>Model Library</h2>
      <p class="section-desc">Pull Ollama LLMs and ComfyUI LTX-2 models. Use the dashboard or run model-puller on demand.</p>
      <div class="models-grid">
        <div class="model-panel">
          <h3>Ollama — LLM & embeddings</h3>
          <div class="model-list" id="ollama-models">
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line short"></div>
            <div class="skeleton skeleton-line"></div>
          </div>
          <div class="pull-area">
            <div class="pull-row">
              <div class="model-select-wrap">
                <div class="model-select-trigger" id="ollama-select-trigger" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-controls="ollama-select-dropdown" aria-labelledby="ollama-select-label" tabindex="0">
                  <span id="ollama-select-label">Select model to pull...</span>
                  <span class="chevron" aria-hidden="true">▼</span>
                </div>
                <div class="model-select-dropdown" id="ollama-select-dropdown" role="listbox" aria-labelledby="ollama-select-label" style="display:none;">
                  <div class="model-select-search">
                    <input type="text" id="ollama-library-search" placeholder="Search 150+ models..." autocomplete="off" aria-label="Search Ollama models">
                  </div>
                  <div class="section-label">Ollama library — click to select</div>
                  <div id="ollama-select-options"></div>
                  <div class="model-select-custom">
                    <input type="text" id="ollama-model-custom" placeholder="Or type any model name" aria-label="Custom model name">
                  </div>
                </div>
              </div>
              <button id="ollama-starter-pack" class="secondary">Starter pack</button>
              <button id="ollama-pull">Pull</button>
            </div>
            <p class="section-desc" style="margin:0.5rem 0 0;font-size:0.8rem;">Starter pack: reasoning + coding + embedding (deepseek-r1:7b, deepseek-coder:6.7b, nomic-embed-text)</p>
            <div class="last-updated" id="ollama-last-updated"></div>
            <div id="ollama-progress" class="progress-area" style="display:none;" role="region" aria-label="Pull progress">
              <div class="progress-bar"><div class="fill" id="ollama-progress-bar" style="width:0%" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div></div>
              <div class="log" id="ollama-log" role="log" aria-live="polite"></div>
            </div>
          </div>
        </div>
        <div class="model-panel">
          <h3>ComfyUI — LTX-2 image gen</h3>
          <div class="model-list" id="comfyui-models">
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line short"></div>
          </div>
          <div class="pull-area">
            <div class="pull-row">
              <button id="comfyui-pull">Pull LTX-2 models (~60 GB)</button>
            </div>
            <div id="comfyui-progress" class="progress-area" style="display:none;" role="region" aria-label="ComfyUI pull progress">
              <div class="log" id="comfyui-log" role="log" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast-container" id="toasts" role="region" aria-label="Notifications" aria-live="polite"></div>

  <div id="auth-modal" class="modal-overlay" style="display:none;" role="dialog" aria-labelledby="auth-modal-title" aria-modal="true">
    <div class="modal-content" style="max-width:360px;">
      <h2 id="auth-modal-title">Dashboard login</h2>
      <p>Enter the shared token to access the dashboard.</p>
      <form id="auth-form" onsubmit="return submitAuth(event)">
        <input type="password" id="auth-token-input" placeholder="Token" autocomplete="current-password" aria-label="Token" />
        <button type="submit">Continue</button>
      </form>
    </div>
  </div>

  <script>
    let authConfig = { auth_required: false, auth_type: null };
    const AUTH_STORAGE_KEY = 'dashboard_auth_token';

    async function loadAuthConfig() {
      try {
        const r = await fetch('/api/auth/config', { cache: 'no-store' });
        authConfig = await r.json();
      } catch (_) { authConfig = { auth_required: false }; }
    }

    function getAuthHeaders() {
      if (!authConfig.auth_required || authConfig.auth_type !== 'bearer') return {};
      const t = sessionStorage.getItem(AUTH_STORAGE_KEY);
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    function showAuthModal() {
      document.getElementById('auth-modal').style.display = 'flex';
      document.getElementById('auth-token-input').focus();
    }

    function hideAuthModal() {
      document.getElementById('auth-modal').style.display = 'none';
    }

    function submitAuth(e) {
      e.preventDefault();
      const input = document.getElementById('auth-token-input');
      const token = (input?.value || '').trim();
      if (!token) return false;
      sessionStorage.setItem(AUTH_STORAGE_KEY, token);
      hideAuthModal();
      window.dispatchEvent(new Event('auth-ready'));
      return false;
    }

    const api = (path, opts = {}) => {
      const headers = { 'Accept': 'application/json', ...getAuthHeaders(), ...opts.headers };
      return fetch(path, { cache: 'no-store', ...opts, headers }).then(async r => {
        if (r.status === 401 && authConfig.auth_required && authConfig.auth_type === 'bearer') {
          sessionStorage.removeItem(AUTH_STORAGE_KEY);
          showAuthModal();
        }
        return r;
      });
    };

    let ollamaModels = [];
    let ollamaLibrary = [];

    function toast(msg, type = '') {
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      el.textContent = msg;
      document.getElementById('toasts').appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }

    function formatSize(bytes) {
      if (bytes >= 1e9) return (bytes / 1e9).toFixed(1) + ' GB';
      if (bytes >= 1e6) return (bytes / 1e6).toFixed(0) + ' MB';
      return (bytes / 1e3).toFixed(0) + ' KB';
    }

    let mcpEnabled = [];
    let mcpCatalog = [];
    let mcpDynamic = false;

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function loadMcpServers() {
      try {
        const r = await api('/api/mcp/servers');
        const d = await r.json();
        mcpEnabled = d.enabled || [];
        mcpCatalog = d.catalog || [];
        mcpDynamic = d.dynamic === true;
        const chipsEl = document.getElementById('mcp-enabled-chips');
        const emptyHint = document.getElementById('mcp-empty-hint');
        if (chipsEl) {
          emptyHint.style.display = mcpEnabled.length ? 'none' : 'inline';
          chipsEl.innerHTML = mcpEnabled.length ? mcpEnabled.map(s =>
            `<span class="mcp-chip" title="${escapeHtml(s)}" data-server="${escapeHtml(s)}"><span>${escapeHtml(s)}</span><button type="button" class="mcp-chip-remove mcp-remove-btn" data-server="${escapeHtml(s)}" aria-label="Remove ${escapeHtml(s)}">×</button></span>`
          ).join('') : '';
        }
        const sel = document.getElementById('mcp-add-select');
        const selStatic = document.getElementById('mcp-add-select-static');
        const opts = '<option value="">Choose a tool...</option>' + mcpCatalog
          .filter(s => !mcpEnabled.includes(s))
          .map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`)
          .join('');
        if (sel) sel.innerHTML = opts;
        if (selStatic) selStatic.innerHTML = opts;
        const firstNotEnabled = mcpCatalog.find(s => !mcpEnabled.includes(s));
        document.getElementById('mcp-add-cmd').textContent = './scripts/mcp_add.sh ' + (firstNotEnabled || 'fetch');
        document.getElementById('mcp-remove-cmd').textContent = mcpEnabled[0] ? './scripts/mcp_remove.sh ' + mcpEnabled[0] : './scripts/mcp_remove.sh fetch';
        document.getElementById('mcp-dynamic-row').style.display = mcpDynamic ? 'block' : 'none';
        document.getElementById('mcp-static-row').style.display = mcpDynamic ? 'none' : 'block';
        loadMcpHealth();
      } catch (_) {
        const chipsEl = document.getElementById('mcp-enabled-chips');
        if (chipsEl) chipsEl.innerHTML = '<span class="mcp-empty-hint">Could not load</span>';
      }
    }

    async function loadMcpHealth() {
      const el = document.getElementById('mcp-gateway-status');
      const chipsEl = document.getElementById('mcp-enabled-chips');
      if (!el) return;
      try {
        const r = await api('/api/mcp/health');
        const d = await r.json();
        el.textContent = d.ok ? 'gateway ok' : 'gateway unreachable';
        el.className = 'badge ' + (d.ok ? 'badge-success' : 'badge-error');
        el.title = d.gateway_error || 'Gateway reachable';
        // Per-server status: add status dot to chips (green=ok, yellow=degraded, red=fail)
        if (chipsEl && d.servers && d.servers.length) {
          const byId = {};
          d.servers.forEach(s => { byId[s.id] = s; });
          chipsEl.querySelectorAll('.mcp-chip').forEach(chip => {
            const serverId = chip.dataset.server || chip.querySelector('span')?.textContent?.trim();
            const info = byId[serverId] || byId[serverId?.split('/').pop()];
            let dot = chip.querySelector('.mcp-chip-status');
            if (info) {
              if (!dot) {
                dot = document.createElement('span');
                dot.className = 'mcp-chip-status';
                dot.setAttribute('aria-hidden', 'true');
                dot.style.cssText = 'width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-right:6px;';
                chip.insertBefore(dot, chip.firstChild);
              }
              const statusLabel = info.status || (info.ok ? 'running' : info.error || 'unknown');
              const isDegraded = !info.ok && statusLabel !== 'unknown' && statusLabel !== 'unreachable';
              dot.style.background = info.ok ? 'var(--success)' : (isDegraded ? 'var(--warning)' : 'var(--danger)');
              dot.title = statusLabel;
            }
          });
        }
      } catch (_) {
        el.textContent = 'unknown';
        el.className = 'badge badge-muted';
      }
    }

    let opsAvailable = false;

    async function checkOpsAvailable() {
      try {
        const r = await api('/api/ops/available');
        const d = await r.json();
        opsAvailable = d.available === true;
      } catch (_) {
        opsAvailable = false;
      }
    }

    async function loadServices() {
      const el = document.getElementById('services');
      const summaryEl = document.getElementById('status-summary');
      await checkOpsAvailable();
      try {
        const r = await api('/api/services');
        const d = await r.json();
        const services = d.services || [];
        const okCount = services.filter(s => s.ok).length;
        const total = services.length;
        summaryEl.style.display = 'block';
        summaryEl.className = 'status-summary ' + (okCount === total ? 'all-ok' : 'has-issues');
        summaryEl.innerHTML = okCount === total
          ? `✓ All ${total} services running`
          : `${okCount}/${total} services running — see hints on failed cards`;
        el.innerHTML = services.map(s => `
          <div class="service-card ${s.ok ? '' : 'fail'}" data-service-id="${escapeHtml(s.id)}">
            <div class="service-name">${escapeHtml(s.name)}</div>
            <div class="row">
              <a href="${s.url}" target="_blank" rel="noopener" class="service" style="flex:1;text-decoration:none;color:inherit;min-width:0;" aria-label="Open ${s.name} (opens in new tab)">
                <span class="status ${s.ok ? 'ok' : 'fail'}" aria-hidden="true"></span>
                <span class="label">${escapeHtml(s.name)}</span>
                <span class="external" aria-hidden="true">↗</span>
              </a>
              ${opsAvailable ? `
                <button type="button" class="btn-icon btn-ops-start" data-service-id="${escapeHtml(s.id)}" title="Start" aria-label="Start ${s.name}">▶</button>
                <button type="button" class="btn-icon btn-ops-stop" data-service-id="${escapeHtml(s.id)}" title="Stop" aria-label="Stop ${s.name}">⏹</button>
                <button type="button" class="btn-icon btn-ops-restart" data-service-id="${escapeHtml(s.id)}" title="Restart" aria-label="Restart ${s.name}">↻</button>
                <button type="button" class="btn-icon btn-ops-logs" data-service-id="${escapeHtml(s.id)}" title="View logs" aria-label="View logs for ${s.name}">📋</button>
              ` : ''}
            </div>
            ${!s.ok && s.hint ? `<div class="hint">${s.hint}</div>` : ''}
          </div>
        `).join('');
        el.querySelectorAll('.btn-ops-start').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.dataset.serviceId;
            btn.classList.add('loading');
            try {
              const r = await api('/api/ops/services/' + id + '/start', { method: 'POST' });
              const d = await r.json();
              if (r.ok) {
                toast(id + ' started');
                loadServices();
              } else {
                toast((d.detail || 'Failed') + '', 'error');
              }
            } catch (err) {
              toast('Start failed: ' + (err.message || err), 'error');
            } finally {
              btn.classList.remove('loading');
            }
          });
        });
        el.querySelectorAll('.btn-ops-stop').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.dataset.serviceId;
            btn.classList.add('loading');
            try {
              const r = await api('/api/ops/services/' + id + '/stop', { method: 'POST' });
              const d = await r.json();
              if (r.ok) {
                toast(id + ' stopped');
                loadServices();
              } else {
                toast((d.detail || 'Failed') + '', 'error');
              }
            } catch (err) {
              toast('Stop failed: ' + (err.message || err), 'error');
            } finally {
              btn.classList.remove('loading');
            }
          });
        });
        el.querySelectorAll('.btn-ops-restart').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.dataset.serviceId;
            btn.classList.add('loading');
            try {
              const r = await api('/api/ops/services/' + id + '/restart', { method: 'POST' });
              const d = await r.json();
              if (r.ok) {
                toast(id + ' restarted');
                loadServices();
              } else {
                toast((d.detail || 'Failed') + '', 'error');
              }
            } catch (err) {
              toast('Restart failed: ' + (err.message || err), 'error');
            } finally {
              btn.classList.remove('loading');
            }
          });
        });
        el.querySelectorAll('.btn-ops-logs').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.dataset.serviceId;
            try {
              const r = await api('/api/ops/services/' + id + '/logs?tail=100');
              const d = await r.json();
              if (r.ok && d.logs) {
                const win = window.open('', '_blank', 'width=800,height=600');
                win.document.write('<pre style="font-family:monospace;white-space:pre-wrap;padding:1rem;font-size:12px;">' + escapeHtml(d.logs) + '</pre>');
                win.document.close();
              } else {
                toast((d.detail || 'No logs') + '', 'error');
              }
            } catch (err) {
              toast('Logs failed: ' + (err.message || err), 'error');
            }
          });
        });
      } catch (e) {
        summaryEl.style.display = 'block';
        summaryEl.className = 'status-summary has-issues';
        summaryEl.innerHTML = 'Could not reach services';
        el.innerHTML = '<div class="empty">Run: docker compose up -d</div>';
      }
    }

    function buildOllamaDropdown(filter = '') {
      const installed = new Set(ollamaModels.map(m => m.name));
      const optionsEl = document.getElementById('ollama-select-options');
      if (!optionsEl) return;
      const q = filter.toLowerCase().trim();
      const models = q ? ollamaLibrary.filter(m => m.toLowerCase().includes(q)) : ollamaLibrary;
      optionsEl.innerHTML = models.slice(0, 80).map(name => {
        const isInstalled = installed.has(name);
        return `<div class="model-select-option ${isInstalled ? 'installed' : ''}" data-model="${name}" role="option" ${isInstalled ? 'aria-disabled="true"' : ''} tabindex="-1">
          <span>${name}</span>
          ${isInstalled ? '<span class="badge badge-success">✓</span>' : '<span class="size">pull</span>'}
        </div>`;
      }).join('');
      if (models.length > 80) {
        optionsEl.innerHTML += `<div class="section-label" style="border:none;padding:0.5rem;">+ ${models.length - 80} more — type to search</div>`;
      }
    }

    async function loadOllamaLibrary() {
      try {
        const r = await api('/api/ollama/library');
        const d = await r.json();
        ollamaLibrary = d.models || [];
      } catch (_) {
        ollamaLibrary = ['llama3.2', 'deepseek-r1:7b', 'qwen2.5:7b', 'mistral', 'nomic-embed-text'];
      }
    }

    async function loadOllamaModels() {
      const el = document.getElementById('ollama-models');
      try {
        const r = await api('/api/ollama/models');
        const d = await r.json();
        ollamaModels = d.models || [];
        buildOllamaDropdown(document.getElementById('ollama-library-search')?.value || '');
        if (!d.ok) {
          el.innerHTML = '<div class="empty">Ollama unreachable.<span class="hint">Start with: docker compose up -d</span></div>';
          return;
        }
        if (!ollamaModels.length) {
          el.innerHTML = '<div class="empty">No models yet.<span class="hint">Select one below and click Pull.</span></div>';
          document.getElementById('ollama-last-updated').textContent = '';
          populateThroughputModelSelect();
          return;
        }
        document.getElementById('ollama-last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();
        el.innerHTML = ollamaModels.map(m => `
          <div class="model-item">
            <span class="name">${escapeHtml(m.name)}</span>
            <span class="meta">${formatSize(m.size || 0)}</span>
            <button type="button" class="btn-model-delete" data-model="${escapeHtml(m.name)}" title="Delete model" aria-label="Delete ${escapeHtml(m.name)}">×</button>
          </div>
        `).join('');
        populateThroughputModelSelect();
      } catch (e) {
        el.innerHTML = '<div class="empty">Failed to load models.</div>';
      }
    }

    function isEmbeddingModel(name) {
      const n = (name || '').toLowerCase();
      return /embed|bge|mxbai|arctic-embed|granite-embedding|paraphrase-multilingual/.test(n);
    }
    function populateThroughputModelSelect() {
      const sel = document.getElementById('throughput-model-select');
      if (!sel) return;
      const llms = ollamaModels.filter(m => !isEmbeddingModel(m.name));
      if (!llms.length) {
        sel.innerHTML = '<option value="">No LLMs — pull one (embedding models excluded)</option>';
        return;
      }
      sel.innerHTML = llms.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('');
    }

    function showLastBenchmark(b) {
      if (!b) return;
      const resultsEl = document.getElementById('throughput-results');
      const errorEl = document.getElementById('throughput-error');
      const loadingEl = document.getElementById('throughput-loading');
      if (!resultsEl) return;
      document.getElementById('throughput-tps').textContent = (b.output_tokens_per_sec ?? 0) + ' tok/s';
      document.getElementById('throughput-output-tokens').textContent = String(b.output_tokens ?? '—');
      document.getElementById('throughput-eval-ms').textContent = (typeof b.eval_duration_ms === 'number' ? b.eval_duration_ms + ' ms' : '—');
      document.getElementById('throughput-load-ms').textContent = (typeof b.load_duration_ms === 'number' ? b.load_duration_ms + ' ms' : '—');
      resultsEl.style.display = 'grid';
      if (errorEl) errorEl.style.display = 'none';
      if (loadingEl) loadingEl.style.display = 'none';
    }

    async function loadThroughputStats() {
      const grid = document.getElementById('throughput-stats-grid');
      if (!grid) return;
      let loadedModels = new Set();
      try {
        const ps = await api('/api/ollama/ps');
        if (ps.ok) {
          const d = await ps.json();
          (d.models || []).forEach(m => {
            const n = (m.name || m.model || '').trim();
            if (n) {
              loadedModels.add(n);
              loadedModels.add(n.split(':')[0]);
            }
          });
        }
      } catch (_) {}
      try {
        const r = await api('/api/throughput/stats');
        const d = await r.json();
        if (d.last_benchmark) showLastBenchmark(d.last_benchmark);
        if (!d.ok || !d.models || Object.keys(d.models).length === 0) {
          grid.innerHTML = '<div class="throughput-empty" id="throughput-stats-empty">No data yet. Run a benchmark or use models via the Model Gateway.</div>';
          return;
        }
        const models = Object.entries(d.models);
        models.sort((a, b) => (b[1].latest || 0) - (a[1].latest || 0));
        const existing = grid.querySelectorAll('.throughput-stat-card');
        if (existing.length !== models.length || models.some(([name], i) => {
          const card = existing[i];
          return !card || card.dataset.model !== name;
        })) {
          grid.innerHTML = '';
          models.forEach(([name, s]) => {
            const card = document.createElement('div');
            card.className = 'throughput-stat-card' + (loadedModels.has(name.split(':')[0]) ? ' loaded' : '');
            card.dataset.model = name;
            card.innerHTML = `
              <div class="throughput-stat-model">
                ${escapeHtml(name)}
                ${loadedModels.has(name.split(':')[0]) ? '<span class="throughput-stat-badge">loaded</span>' : ''}
              </div>
              <div class="throughput-stat-row"><span class="label">Current</span><span class="value">${s.latest} tok/s</span></div>
              <div class="throughput-stat-row"><span class="label">Peak</span><span class="value">${s.peak} tok/s</span></div>
              <div class="throughput-stat-row"><span class="label">p50</span><span class="value">${s.p50} tok/s</span></div>
              <div class="throughput-stat-row"><span class="label">p95</span><span class="value">${s.p95} tok/s</span></div>
              <div class="throughput-stat-row"><span class="label">p99</span><span class="value">${s.p99} tok/s</span></div>
              <div class="throughput-stat-row"><span class="label">Samples</span><span class="value">${s.sample_count}</span></div>
            `;
            grid.appendChild(card);
          });
        }
      } catch (_) {
        grid.innerHTML = '<div class="throughput-empty" id="throughput-stats-empty">Failed to load stats.</div>';
      }
    }

    async function loadThroughputServiceUsage() {
      const container = document.getElementById('throughput-service-usage');
      const empty = document.getElementById('throughput-service-usage-empty');
      if (!container) return;
      try {
        const r = await api('/api/throughput/service-usage');
        const d = await r.json();
        if (!d.ok || !d.by_model || Object.keys(d.by_model).length === 0) {
          container.innerHTML = '<div class="throughput-empty" id="throughput-service-usage-empty">No service usage yet. Use models via the Model Gateway (e.g. Open WebUI with OPENAI_API_BASE).</div>';
          return;
        }
        container.innerHTML = '';
        const entries = Object.entries(d.by_model).sort((a, b) => b[0].localeCompare(a[0]));
        entries.forEach(([model, info]) => {
          const card = document.createElement('div');
          card.className = 'throughput-service-card';
          const services = info.services || [];
          const lastTs = services.length ? Math.max(...services.map(s => s.last_ts || 0)) : 0;
          const ago = lastTs ? (Date.now() / 1000 - lastTs < 60 ? 'just now' : Math.round((Date.now() / 1000 - lastTs) / 60) + 'm ago') : '';
          card.innerHTML = `
            <h4>${escapeHtml(model)}</h4>
            ${services.map(s => `
              <div class="throughput-service-row">
                <span class="label">${escapeHtml(s.name)}</span>
                <span class="value">${s.last_tps} tok/s (${s.count}×)</span>
              </div>
            `).join('')}
            ${ago ? `<div class="throughput-service-row"><span class="label">Last</span><span class="value">${ago}</span></div>` : ''}
          `;
          container.appendChild(card);
        });
      } catch (_) {
        container.innerHTML = '<div class="throughput-empty" id="throughput-service-usage-empty">Failed to load service usage.</div>';
      }
    }

    async function runThroughputBenchmark() {
      const btn = document.getElementById('throughput-run-btn');
      const resultsEl = document.getElementById('throughput-results');
      const errorEl = document.getElementById('throughput-error');
      const loadingEl = document.getElementById('throughput-loading');
      const modelSel = document.getElementById('throughput-model-select');
      const llms = ollamaModels.filter(m => !isEmbeddingModel(m.name));
      const model = modelSel?.value?.trim() || llms[0]?.name || 'llama3.2';
      resultsEl.style.display = 'none';
      errorEl.style.display = 'none';
      errorEl.textContent = '';
      loadingEl.style.display = 'block';
      btn.disabled = true;
      try {
        const r = await api('/api/throughput/benchmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Benchmark failed');
        document.getElementById('throughput-tps').textContent = d.output_tokens_per_sec + ' tok/s';
        document.getElementById('throughput-output-tokens').textContent = d.output_tokens;
        document.getElementById('throughput-eval-ms').textContent = d.eval_duration_ms + ' ms';
        document.getElementById('throughput-load-ms').textContent = d.load_duration_ms + ' ms';
        resultsEl.style.display = 'grid';
        loadThroughputStats();
        loadThroughputServiceUsage();
      } catch (err) {
        errorEl.textContent = err.message || 'Benchmark failed';
        errorEl.style.display = 'block';
      } finally {
        loadingEl.style.display = 'none';
        btn.disabled = false;
      }
    }

    async function loadComfyuiModels() {
      const el = document.getElementById('comfyui-models');
      try {
        const r = await api('/api/comfyui/models');
        const d = await r.json();
        if (!d.ok || !d.models?.length) {
          el.innerHTML = '<div class="empty">No ComfyUI models.<span class="hint">Click Pull LTX-2 models to download (~60 GB).</span></div>';
          return;
        }
        const byCat = {};
        d.models.forEach(m => {
          if (!byCat[m.category]) byCat[m.category] = [];
          byCat[m.category].push(m);
        });
        el.innerHTML = Object.entries(byCat).map(([cat, models]) => `
          ${models.map(m => `
            <div class="model-item">
              <div>
                <span class="name">${escapeHtml(m.name)}</span>
                <div class="model-category">${escapeHtml(cat.replace(/_/g, ' '))}</div>
              </div>
              <span class="meta">${m.size_mb} MB</span>
              <button type="button" class="btn-model-delete" data-category="${escapeHtml(cat)}" data-filename="${escapeHtml(m.name)}" title="Delete model" aria-label="Delete ${escapeHtml(m.name)}">×</button>
            </div>
          `).join('')}
        `).join('');
      } catch (e) {
        el.innerHTML = '<div class="empty">Failed to load models.</div>';
      }
    }

    function getSelectedOllamaModel() {
      const custom = document.getElementById('ollama-model-custom').value.trim();
      if (custom) return custom;
      const label = document.getElementById('ollama-select-label').textContent;
      return label !== 'Select model to pull...' ? label : '';
    }

    function setSelectedOllamaModel(name) {
      document.getElementById('ollama-model-custom').value = '';
      document.getElementById('ollama-select-label').textContent = name || 'Select model to pull...';
    }

    function toggleOllamaDropdown(open) {
      const trigger = document.getElementById('ollama-select-trigger');
      const dd = document.getElementById('ollama-select-dropdown');
      dd.style.display = open ? 'flex' : 'none';
      trigger.classList.toggle('open', open);
      trigger.setAttribute('aria-expanded', open);
      if (open) {
        document.getElementById('ollama-library-search').value = '';
        document.getElementById('ollama-library-search').focus();
        buildOllamaDropdown('');
      }
    }
    document.getElementById('ollama-select-trigger').onclick = (e) => {
      e.stopPropagation();
      const dd = document.getElementById('ollama-select-dropdown');
      toggleOllamaDropdown(dd.style.display !== 'flex');
    };
    document.getElementById('ollama-select-trigger').onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const dd = document.getElementById('ollama-select-dropdown');
        toggleOllamaDropdown(dd.style.display !== 'flex');
      }
    };

    document.getElementById('ollama-select-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.model-select-option');
      if (!opt || opt.classList.contains('installed')) return;
      const model = opt.dataset.model;
      setSelectedOllamaModel(model);
      toggleOllamaDropdown(false);
      document.getElementById('ollama-library-search').value = '';
    });

    document.getElementById('ollama-library-search').oninput = (e) => {
      buildOllamaDropdown(e.target.value);
    };

    document.getElementById('ollama-library-search').onkeydown = (e) => {
      e.stopPropagation();
      if (e.key === 'Escape') {
        toggleOllamaDropdown(false);
        document.getElementById('ollama-select-trigger').focus();
      }
    };

    document.getElementById('ollama-model-custom').oninput = () => {
      const v = document.getElementById('ollama-model-custom').value.trim();
      document.getElementById('ollama-select-label').textContent = v || 'Select model to pull...';
    };

    document.addEventListener('click', () => {
      const dd = document.getElementById('ollama-select-dropdown');
      if (dd.style.display === 'flex') toggleOllamaDropdown(false);
    });
    document.getElementById('ollama-select-dropdown').onclick = (e) => e.stopPropagation();
    document.getElementById('ollama-select-dropdown').onkeydown = (e) => {
      if (e.key === 'Escape') {
        toggleOllamaDropdown(false);
        document.getElementById('ollama-select-trigger').focus();
      }
    };

    async function pullOllamaModel(name, btn, prog, logEl, barEl) {
      logEl.textContent = `Pulling ${name}...`;
      barEl.style.width = '0%';
      barEl.setAttribute('aria-valuenow', 0);
      const r = await fetch('/api/ollama/pull', {
        method: 'POST',
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: name })
      });
      const reader = r.body.getReader();
      const dec = new TextDecoder();
      let buf = '', out = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop() || '';
        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const j = JSON.parse(line);
            if (j.status) out += j.status + '\n';
            if (j.completed != null && j.total && j.total > 0) {
              const pct = Math.round((j.completed / j.total) * 100);
              barEl.style.width = pct + '%';
              barEl.setAttribute('aria-valuenow', pct);
            }
          } catch (_) {}
        }
        logEl.textContent = out || 'Pulling...';
        logEl.scrollTop = logEl.scrollHeight;
      }
      barEl.style.width = '100%';
      barEl.setAttribute('aria-valuenow', 100);
      logEl.textContent += '\n✓ Done.';
    }

    document.getElementById('ollama-starter-pack').onclick = async () => {
      const STARTER_PACK = ['deepseek-r1:7b', 'deepseek-coder:6.7b', 'nomic-embed-text'];
      const btn = document.getElementById('ollama-starter-pack');
      const pullBtn = document.getElementById('ollama-pull');
      const prog = document.getElementById('ollama-progress');
      const logEl = document.getElementById('ollama-log');
      const barEl = document.getElementById('ollama-progress-bar');
      btn.disabled = true;
      pullBtn.disabled = true;
      prog.style.display = 'block';
      logEl.textContent = 'Starting Starter pack...';
      try {
        for (const name of STARTER_PACK) {
          await pullOllamaModel(name, btn, prog, logEl, barEl);
        }
        toast('Starter pack complete', 'success');
        await loadOllamaModels();
      } catch (e) {
        logEl.textContent += '\nError: ' + e.message;
        toast('Starter pack failed: ' + e.message, 'error');
      }
      btn.disabled = false;
      pullBtn.disabled = false;
    };

    document.getElementById('ollama-pull').onclick = async () => {
      const name = getSelectedOllamaModel();
      if (!name) { toast('Enter a model name', 'error'); return; }
      const btn = document.getElementById('ollama-pull');
      const prog = document.getElementById('ollama-progress');
      const logEl = document.getElementById('ollama-log');
      const barEl = document.getElementById('ollama-progress-bar');
      btn.disabled = true;
      document.getElementById('ollama-starter-pack').disabled = true;
      prog.style.display = 'block';
      logEl.textContent = 'Connecting...';
      try {
        await pullOllamaModel(name, btn, prog, logEl, barEl);
        toast(`Pulled ${name}`, 'success');
        setSelectedOllamaModel('');
        await loadOllamaModels();
      } catch (e) {
        logEl.textContent += '\nError: ' + e.message;
        toast('Pull failed: ' + e.message, 'error');
      }
      btn.disabled = false;
      document.getElementById('ollama-starter-pack').disabled = false;
    };

    document.getElementById('comfyui-pull').onclick = async () => {
      const btn = document.getElementById('comfyui-pull');
      const prog = document.getElementById('comfyui-progress');
      const logEl = document.getElementById('comfyui-log');
      btn.disabled = true;
      prog.style.display = 'block';
      logEl.textContent = 'Starting download...';
      try {
        await api('/api/comfyui/pull', { method: 'POST' });
        const poll = () => {
          api('/api/comfyui/pull/status').then(r => r.json()).then(s => {
            logEl.textContent = s.output || 'Preparing...';
            logEl.scrollTop = logEl.scrollHeight;
            if (s.running) setTimeout(poll, 1500);
            else {
              logEl.textContent += '\n' + (s.success ? '✓ Done.' : '✗ Failed.');
              toast(s.success ? 'LTX-2 models ready' : 'Download failed', s.success ? 'success' : 'error');
              btn.disabled = false;
              loadComfyuiModels();
            }
          });
        };
        poll();
      } catch (e) {
        logEl.textContent += '\nError: ' + e.message;
        toast('Failed to start pull', 'error');
        btn.disabled = false;
      }
    };

    async function refresh() {
      const btn = document.getElementById('refresh-btn');
      btn.classList.add('loading');
      if (!ollamaLibrary.length) await loadOllamaLibrary();
      await Promise.all([loadServices(), loadOllamaModels(), loadComfyuiModels(), loadMcpServers()]);
      loadThroughputStats();
      loadThroughputServiceUsage();
      btn.classList.remove('loading');
    }

    document.getElementById('mcp-add-select')?.addEventListener('change', function() {
      document.getElementById('mcp-add-cmd').textContent = './scripts/mcp_add.sh ' + (this.value || 'fetch');
    });
    document.getElementById('mcp-add-btn')?.addEventListener('click', async () => {
      const v = document.getElementById('mcp-add-select')?.value;
      if (!v) { toast('Select a tool from the dropdown or use "Add custom"', 'error'); return; }
      try {
        const r = await api('/api/mcp/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ server: v }) });
        const d = await r.json();
        if (!r.ok) { toast(d.detail || 'Failed to add', 'error'); return; }
        toast(d.status === 'already_enabled' ? `${v} already enabled` : `Added ${v}. Reloading in ~10s.`, 'success');
        await loadMcpServers();
      } catch (e) {
        toast('Failed to add', 'error');
      }
    });
    async function addMcpServer(server) {
      const v = server?.trim();
      if (!v) return false;
      try {
        const r = await api('/api/mcp/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ server: v }) });
        const d = await r.json();
        if (!r.ok) { toast(d.detail || 'Failed to add', 'error'); return false; }
        toast(d.status === 'already_enabled' ? `${v} already enabled` : `Added ${v}. Reloading in ~10s.`, 'success');
        await loadMcpServers();
        return true;
      } catch (e) {
        toast('Failed to add', 'error');
        return false;
      }
    }
    document.getElementById('mcp-add-custom-btn')?.addEventListener('click', async () => {
      const input = document.getElementById('mcp-custom-input');
      const v = input?.value?.trim();
      if (!v) { toast('Enter a server name (e.g. mcp/firecrawl or fetch)', 'error'); return; }
      if (await addMcpServer(v)) input.value = '';
    });
    document.getElementById('mcp-custom-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const input = document.getElementById('mcp-custom-input');
        const v = input?.value?.trim();
        if (v) addMcpServer(v).then(ok => { if (ok) input.value = ''; });
      }
    });
    document.getElementById('mcp-add-select-static')?.addEventListener('change', function() {
      if (this.value) document.getElementById('mcp-add-cmd').textContent = './scripts/mcp_add.sh ' + this.value;
    });
    document.getElementById('mcp-add-btn-static')?.addEventListener('click', () => {
      const v = document.getElementById('mcp-add-select-static')?.value || 'fetch';
      const cmd = './scripts/mcp_add.sh ' + v;
      navigator.clipboard?.writeText(cmd).then(() => toast('Copied: ' + cmd, 'success')).catch(() => toast(cmd));
    });
    document.getElementById('mcp-add-copy')?.addEventListener('click', () => {
      const cmd = document.getElementById('mcp-add-cmd').textContent;
      navigator.clipboard?.writeText(cmd).then(() => toast('Copied', 'success')).catch(() => toast(cmd));
    });
    document.getElementById('mcp-remove-copy')?.addEventListener('click', () => {
      const cmd = document.getElementById('mcp-remove-cmd').textContent;
      navigator.clipboard?.writeText(cmd).then(() => toast('Copied', 'success')).catch(() => toast(cmd));
    });
    document.getElementById('mcp-enabled-chips')?.addEventListener('click', async (e) => {
      const btn = e.target.closest('.mcp-remove-btn');
      if (!btn) return;
      const server = btn.dataset.server;
      try {
        const r = await api('/api/mcp/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ server }) });
        const d = await r.json();
        if (!r.ok) { toast(d.detail || 'Failed to remove', 'error'); return; }
        toast(d.status === 'already_removed' ? `${server} already removed` : `Removed ${server}. Reloading in ~10s.`, 'success');
        await loadMcpServers();
      } catch (e) {
        toast('Failed to remove', 'error');
      }
    });

    document.getElementById('refresh-btn').onclick = refresh;
    document.getElementById('throughput-run-btn').onclick = runThroughputBenchmark;

    document.getElementById('ollama-models')?.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-model-delete[data-model]');
      if (!btn) return;
      e.preventDefault();
      const model = btn.dataset.model;
      if (!model || !confirm(`Delete Ollama model "${model}"? This cannot be undone.`)) return;
      btn.disabled = true;
      try {
        const r = await api('/api/ollama/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model }) });
        const d = await r.json();
        if (r.ok) {
          toast(d.message || 'Model deleted');
          loadOllamaModels();
          loadThroughputStats();
        } else {
          toast((d.detail || 'Delete failed') + '', 'error');
        }
      } catch (err) {
        toast('Delete failed: ' + (err.message || err), 'error');
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('comfyui-models')?.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-model-delete[data-category]');
      if (!btn) return;
      e.preventDefault();
      const cat = btn.dataset.category;
      const filename = btn.dataset.filename;
      if (!cat || !filename || !confirm(`Delete ComfyUI model "${filename}" from ${cat}? This cannot be undone.`)) return;
      btn.disabled = true;
      try {
        const r = await api('/api/comfyui/models/' + encodeURIComponent(cat) + '/' + encodeURIComponent(filename), { method: 'DELETE' });
        const d = await r.json();
        if (r.ok) {
          toast(d.message || 'Model deleted');
          loadComfyuiModels();
        } else {
          toast((d.detail || 'Delete failed') + '', 'error');
        }
      } catch (err) {
        toast('Delete failed: ' + (err.message || err), 'error');
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('rebuild-hint').onclick = () => {
      const cmd = 'docker compose build dashboard; docker compose up -d';
      navigator.clipboard?.writeText(cmd).then(() => toast('Rebuild command copied to clipboard', 'success')).catch(() => toast(cmd));
    };

    (async function init() {
      await loadAuthConfig();
      if (authConfig.auth_required && authConfig.auth_type === 'bearer' && !sessionStorage.getItem(AUTH_STORAGE_KEY)) {
        showAuthModal();
        window.addEventListener('auth-ready', () => { loadOllamaLibrary().then(() => refresh()); }, { once: true });
      } else {
        loadOllamaLibrary().then(() => refresh());
      }
      setInterval(refresh, 15000);
    })();
  </script>
</body>
</html>
